#!/bin/bash

CERT_INCLUDE_DIR=${1}
. ${CERT_INCLUDE_DIR}/config.inc
. ${CERT_INCLUDE_DIR}/modem.inc

cell_test_run=${CERT_TEST_STATUS_HOME}/${2}_test.run
echo 0 > ${cell_test_run}

at_test_output=${CERT_TEST_OUTPUT}/${2}_test.out

# Detect modem and set correct AT port
function detect_modem_port() {
	local telit_fn990="1bc7:1070"
	local telit_le910c4="1bc7:1031"

	# Try using mmcli first
	if command -v mmcli &>/dev/null; then
		local modem_list=$(mmcli -L)
		local modem_id=$(echo "${modem_list}" | grep -oP "Modem/\K[0-9]+" | head -1)
		if [[ -n "${modem_id}" ]]; then
			local modem_name=$(echo "${modem_list}" | grep -oP "\[.*?\]" | sed 's/\[//;s/\]//' | head -1)
			echo "ModemManager modem ${modem_id} detected: ${modem_name}"
			local modem_info=$(mmcli -m ${modem_id})
			echo "DEBUG: Extracting AT port from mmcli output..." >&2
			echo "${modem_info}" | grep -i "ports:" >&2
			# Extract AT port - look for (at) in the ports line
			local at_port=$(echo "${modem_info}" | grep -iE "ports:" | grep -oP "(ttyUSB|ttyACM)\d+\s*\(at\)" | head -1 | grep -oP "(ttyUSB|ttyACM)\d+")
			if [[ -n "${at_port}" ]]; then
				cell_modem="/dev/${at_port}"
				echo "Using mmcli detected AT port: ${cell_modem}"
				at_modem="${cell_modem}"
				return 0
			else
				echo "Warning: mmcli detected modem but couldn't extract AT port, falling back to USB detection" >&2
			fi
		fi
	fi

	# Fallback to lsusb
	local usb_devices=$(lsusb -d ${telit_le910c4} 2>/dev/null || lsusb -d ${telit_fn990} 2>/dev/null || echo "")
	if [[ -n "${usb_devices}" ]]; then
		echo "Telit modem detected via lsusb"
		if [[ -e "/dev/ttyUSB2" ]]; then
			cell_modem="/dev/ttyUSB2"
			echo "Using standard Telit AT port: ${cell_modem}"
		elif ls /dev/ttyUSB* &>/dev/null; then
			cell_modem="$(ls /dev/ttyUSB* | sort -V | tail -1)"  # Use last ttyUSB port
			echo "Using highest ttyUSB port: ${cell_modem}"
		elif ls /dev/ttyACM* &>/dev/null; then
			cell_modem="$(ls /dev/ttyACM* | head -1)"
			echo "Using ttyACM port: ${cell_modem}"
		else
			echo "Error: No ttyUSB or ttyACM ports found"
			return 1
		fi
	else
		echo "Using default cell_modem: ${cell_modem}"
	fi

	at_modem="${cell_modem}"
	echo "AT modem port set to: ${at_modem}"
}

detect_modem_port

AT_RESET="AT+CFUN=1,1"
AT_SCAN_NET="AT+COPS=?"
AT_GET_ICCID="AT+CICCID"
AT_QSIMSTAT="AT+QSIMSTAT?"

function Wait_until_modem_detected() {
    while [ ! -c ${cell_modem} ]; do
        echo 0 > ${cell_test_run}
		echo "Waiting to detect modem ${cell_modem}"
        sleep ${cell_test_sleep};
    done
}

function reset_modem() {
    echo "=== Reset Modem ==="
    gpioset ${cell_rst_gpio_chip} ${cell_rst_gpio}=1
    sleep ${cell_test_sim_timeout}
    gpioset ${cell_rst_gpio_chip} ${cell_rst_gpio}=0
}

function wait_for_sim() {
    local sim_det=${1:-0}
    while [ 1 ]; do
        local ret=1
        : > ${at_test_output}
        for ((i=1; i<${REPEATS}; i++)); do
            sleep ${cell_test_sim_timeout}
            modem_query_at_port ${AT_GET_ICCID} 1
            if [[ $? -eq 0 ]]; then
                ret=0
                break
            fi
        done
        : > ${at_test_output}
        if [[ ${ret} -ne 0 ]]; then
            echo 0 > ${cell_test_run}
            echo "=== SIM NOT Detected ==="
            if [[ -z ${sim_det} || ${sim_det} -ne 1 ]] ; then
                # SIM card hot-swap detection disabled: run reset command
                reset_modem
                continue
            else
                # SIM card hot-swap detection enabled: do not reset modem, just wait for SIM insertion
                continue
            fi
        else
            # SIM detected: return 0
            echo "=== SIM Detected ==="
            return 0
        fi
    done
}

function scan_networks() {
    echo "=== Cell Operators Scan ==="
    : > ${at_test_output}
    Wait_until_modem_detected

    # Start reader in background
    timeout ${cell_test_scan_timeout} cat ${cell_modem} > ${at_test_output} 2>/dev/null &
    local read_pid=$!
    sleep 0.2

    # Send AT command
    echo -e "${AT_SCAN_NET}\r" > ${cell_modem} 2>/dev/null

    # Wait for completion
    wait ${read_pid} 2>/dev/null

    # Check for any response (OK or ERROR, indicates modem is responding)
    if grep -qE "OK|ERROR" ${at_test_output}; then
        echo "Modem scan completed (modem is responding)"
        # Also show what was scanned if successful
        if grep -q "OK" ${at_test_output}; then
            echo "Found operators:"
            grep "+COPS" ${at_test_output} || echo "  (no operators found)"
        fi
        return 0
    else
        echo "Scan timeout or no response from modem"
        return 1
    fi
}

function main() {
    local scenario=${1:-"SIM"}
    while [ 1 ]; do
        Wait_until_modem_detected
		initialize_the_modem_TTY_device
        if [[ ${scenario} == "SIM" ]] ; then
            wait_for_sim ${sim_detect}
            echo 1 > ${cell_test_run}
            sleep ${cell_test_sleep}
            continue
        fi
        sleep 2 # rest between AT commands otherwise
        if [[ ${scenario} == "SCAN" ]] ; then
            scan_networks
		    echo $(( $? ^ 1 )) > "${cell_test_run}"
            sleep ${cell_test_sleep}
            continue
        fi
    done
}

#set -x
if [[ "${wb_test_role}" == "DUT" ]] ; then
    main SCAN # SIM
else
    echo 1 > ${cell_test_run}
fi
